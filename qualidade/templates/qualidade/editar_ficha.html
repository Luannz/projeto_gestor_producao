{% extends 'qualidade/base.html' %}
{% load qualidade_filters %}

{% block header_title %}Editar Ficha{% endblock %}

{% block content %}
<!-- Token CSRF oculto para JavaScript usar -->
{% csrf_token %}

<style>
    .ficha-info-bar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 30px;
    }
    
    .ficha-info-bar h2 {
        font-size: 24px;
        margin-bottom: 10px;
    }
    
    .add-parte-section {
        background: white;
        padding: 20px;
        border-radius: 15px;
        border: 2px dashed #667eea;
        margin-bottom: 30px;
    }
    
    .add-parte-form {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .select-parte {
        flex: 1;
        padding: 12px;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        font-size: 16px;
        background: white;
    }
    
    .select-parte:focus {
        outline: none;
        border-color: #667eea;
    }
    
    .btn-add-parte {
        background: #667eea;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.3s;
    }
    
    .btn-add-parte:hover {
        background: #5568d3;
        transform: translateY(-2px);
    }
    
    .partes-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .parte-card {
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 15px;
        padding: 20px;
        transition: all 0.3s;
    }
    
    .parte-card:hover {
        border-color: #667eea;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
    }
    
    .parte-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e5e7eb;
    }
    
    .parte-title-row {
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 1;
    }
    
    .parte-nome {
        font-size: 20px;
        font-weight: 700;
        color: #111827;
    }
    
    .btn-remove-parte {
        background: #ef4444;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-remove-parte:hover {
        background: #dc2626;
    }
    
    .parte-total {
        background: #667eea;
        color: white;
        padding: 6px 14px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 14px;
    }
    
    .quantidades-list {
        max-height: 200px;
        overflow-y: auto;
        margin-bottom: 15px;
        padding: 10px;
        background: #f9fafb;
        border-radius: 10px;
    }
    
    .quantidade-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: white;
        border-radius: 8px;
        margin-bottom: 6px;
        border: 1px solid #e5e7eb;
    }
    
    .quantidade-valor {
        font-weight: 600;
        color: #111827;
        font-size: 16px;
    }
    
    .btn-remove {
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 4px 10px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.3s;
    }
    
    .btn-remove:hover {
        background: #dc2626;
    }
    
    .input-group {
        display: flex;
        gap: 10px;
    }
    
    .quantidade-input {
        flex: 1;
        padding: 12px;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        font-size: 18px;
        font-weight: 600;
        text-align: center;
    }
    
    .quantidade-input:focus {
        outline: none;
        border-color: #667eea;
    }
    
    .btn-add {
        background: #10b981;
        color: white;
        border: none;
        border-radius: 10px;
        padding: 12px 20px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 16px;
    }
    
    .btn-add:hover {
        background: #059669;
        transform: scale(1.05);
    }
    
    .btn-add:active {
        transform: scale(0.95);
    }
    
    .empty-state {
        text-align: center;
        padding: 30px;
        color: #9ca3af;
        font-style: italic;
    }
    
    .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 30px;
    }
    
    .no-partes-message {
        text-align: center;
        padding: 40px;
        background: #f9fafb;
        border-radius: 15px;
        color: #6b7280;
    }
    
    @media (max-width: 768px) {
        .partes-container {
            grid-template-columns: 1fr;
        }
        
        .action-buttons {
            flex-direction: column;
        }
        
        .add-parte-form {
            flex-direction: column;
        }
        
        .select-parte {
            width: 100%;
        }
        
        .btn-add-parte {
            width: 100%;
        }
    }
</style>

<div class="ficha-info-bar">
    <h2>{{ ficha.nome_ficha }}</h2>
    <div>üìÖ {{ ficha.data|date:"d/m/Y" }} | üë§ {{ ficha.operador.get_full_name|default:ficha.operador.username }}</div>
</div>

{% if pode_editar %}
    <!-- SE√á√ÉO: Adicionar Nova Parte -->
    <div class="add-parte-section">
        <h3 style="margin-bottom: 15px; color: #111827;">‚ûï Adicionar Parte</h3>
        <div class="add-parte-form">
            <select id="select-nova-parte" class="select-parte">
                <option value="">Selecione uma parte...</option>
                {% for parte in partes_disponiveis %}
                    {% if parte.id not in partes_adicionadas_ids %}
                    <option value="{{ parte.id }}">{{ parte.nome }}</option>
                    {% endif %}
                {% endfor %}
            </select>
            <button onclick="adicionarNovaParte()" class="btn-add-parte">
                Adicionar Parte
            </button>
        </div>
    </div>

    <!-- SE√á√ÉO: Partes Adicionadas -->
    {% if registros_existentes %}
    <div class="partes-container" id="partes-container">
        {% for registro in registros_existentes %}
        <div class="parte-card" id="parte-card-{{ registro.parte.id }}">
            <div class="parte-header">
                <div class="parte-title-row">
                    <div class="parte-nome">{{ registro.parte.nome }}</div>
                    <button class="btn-remove-parte" onclick="removerParteCard({{ registro.parte.id }}, '{{ registro.parte.nome }}')">
                        üóëÔ∏è Remover
                    </button>
                </div>
                <div class="parte-total" id="total-{{ registro.parte.id }}">
                    Total: {{ registro.total }}
                </div>
            </div>
            
            <div class="quantidades-list" id="lista-{{ registro.parte.id }}">
                {% if registro.quantidades %}
                    {% for qtd in registro.quantidades %}
                    <div class="quantidade-item">
                        <span class="quantidade-valor">{{ qtd }}</span>
                        <button class="btn-remove" onclick="removerQuantidade({{ registro.parte.id }})">‚úï</button>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="empty-state" id="empty-{{ registro.parte.id }}">
                    Nenhuma quantidade adicionada
                </div>
                {% endif %}
            </div>
            
            <div class="input-group">
                <input type="number" 
                       class="quantidade-input" 
                       id="input-{{ registro.parte.id }}"
                       placeholder="Digite a quantidade"
                       min="1"
                       step="1"
                       inputmode="numeric">
                <button type="button" class="btn-add" onclick="adicionarQuantidade({{ registro.parte.id }})">
                    ‚ûï
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="no-partes-message" id="no-partes-message">
        <div style="font-size: 48px; margin-bottom: 15px;">üì¶</div>
        <h3 style="color: #374151; margin-bottom: 10px;">Nenhuma parte adicionada</h3>
        <p>Use o bot√£o "Adicionar Parte" acima para come√ßar</p>
    </div>
    {% endif %}
{% else %}
<div class="alert alert-info">
    Voc√™ n√£o tem permiss√£o para editar esta ficha. Use o bot√£o "Ver" para visualizar o conte√∫do.
</div>
{% endif %}

<div class="action-buttons">
    <a href="{% url 'home' %}" class="btn btn-secondary">‚Üê Voltar</a>
    <a href="{% url 'visualizar_ficha' ficha.id %}" class="btn btn-primary">üëÅÔ∏è Visualizar Completo</a>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Fun√ß√£o melhorada para obter o CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Obter CSRF token do cookie ou do template
function getCSRFToken() {
    let token = getCookie('csrftoken');
    if (!token) {
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
            token = csrfInput.value;
        }
    }
    return token;
}

// Adicionar nova parte √† ficha
async function adicionarNovaParte() {
    const select = document.getElementById('select-nova-parte');
    const parteId = select.value;
    
    if (!parteId) {
        alert('Selecione uma parte');
        return;
    }
    
    const parteNome = select.options[select.selectedIndex].text;
    const csrfToken = getCSRFToken();
    
    try {
        const response = await fetch(`/ficha/{{ ficha.id }}/adicionar-parte/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ parte_id: parteId })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Remover mensagem de "nenhuma parte"
            const noPartesMsg = document.getElementById('no-partes-message');
            if (noPartesMsg) {
                noPartesMsg.remove();
            }
            
            // Criar container se n√£o existir
            let container = document.getElementById('partes-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'partes-container';
                container.className = 'partes-container';
                document.querySelector('.add-parte-section').insertAdjacentElement('afterend', container);
            }
            
            // Adicionar card da parte
            adicionarParteCard(data.parte_id, data.parte_nome);
            
            // Remover op√ß√£o do select
            select.querySelector(`option[value="${parteId}"]`).remove();
            select.value = '';
            
            alert(`Parte "${data.parte_nome}" adicionada com sucesso!`);
        } else {
            alert(data.error || 'Erro ao adicionar parte');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao adicionar parte. Verifique sua conex√£o.');
    }
}

// Adicionar card HTML da parte
function adicionarParteCard(parteId, parteNome) {
    const container = document.getElementById('partes-container');
    
    const cardHTML = `
        <div class="parte-card" id="parte-card-${parteId}">
            <div class="parte-header">
                <div class="parte-title-row">
                    <div class="parte-nome">${parteNome}</div>
                    <button type="button" class="btn-remove-parte" onclick="removerParteCard(${parteId}, '${parteNome}')">
                        üóëÔ∏è Remover
                    </button>
                </div>
                <div class="parte-total" id="total-${parteId}">
                    Total: 0
                </div>
            </div>
            
            <div class="quantidades-list" id="lista-${parteId}">
                <div class="empty-state" id="empty-${parteId}">
                    Nenhuma quantidade adicionada
                </div>
            </div>
            
            <div class="input-group">
                <input type="number" 
                       class="quantidade-input" 
                       id="input-${parteId}"
                       placeholder="Digite a quantidade"
                       min="1"
                       step="1"
                       inputmode="numeric">
                <button type="button" class="btn-add" onclick="adicionarQuantidade(${parteId})">
                    ‚ûï
                </button>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', cardHTML);
    
    // Adicionar event listener de Enter no novo input
    const novoInput = document.getElementById(`input-${parteId}`);
    if (novoInput) {
        adicionarEventoEnter(novoInput);
    }
}

// Remover parte da ficha
async function removerParteCard(parteId, parteNome) {
    if (!confirm(`Tem certeza que deseja remover a parte "${parteNome}"? Todas as quantidades ser√£o perdidas.`)) {
        return;
    }
    
    const csrfToken = getCSRFToken();
    
    try {
        const response = await fetch(`/ficha/{{ ficha.id }}/remover-parte/${parteId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Remover card
            document.getElementById(`parte-card-${parteId}`).remove();
            
            // Adicionar de volta ao select
            const select = document.getElementById('select-nova-parte');
            const option = document.createElement('option');
            option.value = parteId;
            option.textContent = parteNome;
            select.appendChild(option);
            
            // Verificar se n√£o tem mais partes
            const container = document.getElementById('partes-container');
            if (container && container.children.length === 0) {
                container.remove();
                const addSection = document.querySelector('.add-parte-section');
                addSection.insertAdjacentHTML('afterend', `
                    <div class="no-partes-message" id="no-partes-message">
                        <div style="font-size: 48px; margin-bottom: 15px;">üì¶</div>
                        <h3 style="color: #374151; margin-bottom: 10px;">Nenhuma parte adicionada</h3>
                        <p>Use o bot√£o "Adicionar Parte" acima para come√ßar</p>
                    </div>
                `);
            }
        } else {
            alert(data.error || 'Erro ao remover parte');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao remover parte. Verifique sua conex√£o.');
    }
}

// Objeto para controlar requisi√ß√µes em andamento por parte (evita duplica√ß√£o)
const requisicoesEmAndamento = {};

async function adicionarQuantidade(parteId) {
    // Verificar se j√° existe uma requisi√ß√£o em andamento para esta parte
    if (requisicoesEmAndamento[parteId]) {
        console.log(`Requisi√ß√£o j√° em andamento para parte ${parteId}`);
        return;
    }
    
    const input = document.getElementById(`input-${parteId}`);
    const quantidade = parseInt(input.value);
    
    if (!quantidade || quantidade <= 0) {
        alert('Digite uma quantidade v√°lida');
        return;
    }
    
    const csrfToken = getCSRFToken();
    
    if (!csrfToken) {
        alert('Erro: Token CSRF n√£o encontrado. Recarregue a p√°gina.');
        return;
    }
    
    // Marcar esta parte como tendo requisi√ß√£o em andamento
    requisicoesEmAndamento[parteId] = true;
    
    try {
        const response = await fetch(`/ficha/{{ ficha.id }}/parte/${parteId}/adicionar/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ quantidade })
        });
        
        const data = await response.json();
        
        if (data.success) {
            atualizarLista(parteId, data.quantidades, data.total);
            input.value = '';
            input.focus();
        } else {
            alert(data.error || 'Erro ao adicionar quantidade');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao adicionar quantidade. Verifique sua conex√£o.');
    } finally {
        // Liberar ap√≥s um pequeno delay
        setTimeout(() => {
            delete requisicoesEmAndamento[parteId];
        }, 300);
    }
}

async function removerQuantidade(parteId) {
    const csrfToken = getCSRFToken();
    
    if (!csrfToken) {
        alert('Erro: Token CSRF n√£o encontrado. Recarregue a p√°gina.');
        return;
    }
    
    try {
        const response = await fetch(`/ficha/{{ ficha.id }}/parte/${parteId}/remover/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            atualizarLista(parteId, data.quantidades, data.total);
        } else {
            alert(data.error || 'Erro ao remover quantidade');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao remover quantidade. Verifique sua conex√£o.');
    }
}

function atualizarLista(parteId, quantidades, total) {
    const lista = document.getElementById(`lista-${parteId}`);
    const totalEl = document.getElementById(`total-${parteId}`);
    
    // Atualizar total
    totalEl.textContent = `Total: ${total}`;
    
    // Atualizar lista
    if (quantidades.length === 0) {
        lista.innerHTML = '<div class="empty-state">Nenhuma quantidade adicionada</div>';
    } else {
        lista.innerHTML = quantidades.map(qtd => `
            <div class="quantidade-item">
                <span class="quantidade-valor">${qtd}</span>
                <button class="btn-remove" onclick="removerQuantidade(${parteId})">‚úï</button>
            </div>
        `).join('');
    }
}

// Fun√ß√£o auxiliar para adicionar event listener de Enter em um input
function adicionarEventoEnter(input) {
    // Remover listeners antigos (se existirem)
    const novoInput = input.cloneNode(true);
    input.parentNode.replaceChild(novoInput, input);
    
    // Adicionar novo listener
    novoInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' || e.keyCode === 13) {
            e.preventDefault();
            e.stopPropagation();
            const parteId = this.id.replace('input-', '');
            adicionarQuantidade(parteId);
        }
    });
}

// Inicializar event listeners quando a p√°gina carregar
document.addEventListener('DOMContentLoaded', function() {
    const inputs = document.querySelectorAll('.quantidade-input');
    inputs.forEach(input => {
        adicionarEventoEnter(input);
    });
});
</script>
{% endblock %}